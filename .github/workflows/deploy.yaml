# .github/workflows/deploy.yml
name: Deploy to Minikube

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  KUBECONFIG: ${{ github.workspace }}/.kube/config

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:13-alpine
        env:
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
          POSTGRES_DB: mydb
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "**/package-lock.json"

      - name: Install dependencies
        env:
          DATABASE_URL: postgresql://user:password@localhost:5432/mydb
        run: |
          cd backend && npm ci
          cd ../web-dashboard && npm ci

      - name: Run tests
        env:
          DATABASE_URL: postgresql://user:password@localhost:5432/mydb
        run: |
          cd backend && npm test
          cd ../web-dashboard && npm test

  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    services:
      postgres:
        image: postgres:13-alpine
        env:
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
          POSTGRES_DB: mydb
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v3

      - name: Start minikube
        uses: medyagh/setup-minikube@master
        with:
          minikube-version: 1.32.0
          kubernetes-version: 1.28.0

      - name: Build Docker images inside Minikube
        run: |
          # Minikube Docker 환경 설정
          eval $(minikube -p minikube docker-env)

          # 백엔드 이미지 빌드
          echo "Building backend image..."
          docker build -t nestjs-backend:${{ github.sha }} -t nestjs-backend:latest ./backend

          # 웹 대시보드 이미지 빌드
          echo "Building web-dashboard image..."
          docker build -t web-dashboard:${{ github.sha }} -t web-dashboard:latest ./web-dashboard

          # 빌드된 이미지 확인
          echo "Built images:"
          docker images | grep -E "(nestjs-backend|web-dashboard)"

      - name: Deploy to Kubernetes
        run: |
          echo "Applying Kubernetes manifests..."
          # 네임스페이스, 시크릿, 서비스, 인그레스 적용
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/secrets.yaml
          kubectl apply -f k8s/backend-service.yaml
          kubectl apply -f k8s/web-dashboard-service.yaml
          kubectl apply -f k8s/ingress.yaml

          # Deployment 적용
          kubectl apply -f k8s/backend-deployment.yaml
          kubectl apply -f k8s/web-dashboard-deployment.yaml

      - name: Update image to new version
        run: |
          echo "Updating deployments with new images..."
          kubectl set image deployment/nestjs-backend nestjs-backend=nestjs-backend:${{ github.sha }} -n app-deployment
          kubectl set image deployment/web-dashboard web-dashboard=web-dashboard:${{ github.sha }} -n app-deployment

      - name: Wait for rollout to complete
        run: |
          echo "Waiting for deployments to complete..."
          # 배포 상태 확인
          kubectl rollout status deployment/nestjs-backend -n app-deployment --timeout=300s
          kubectl rollout status deployment/web-dashboard -n app-deployment --timeout=300s

          # Pod 상태 확인
          kubectl get pods -n app-deployment

      - name: Update app version
        run: |
          echo "Updating app version..."
          # 백엔드가 준비될 때까지 잠시 대기
          sleep 10

          # 백엔드에 새 버전 정보 업데이트
          kubectl exec -n app-deployment deployment/nestjs-backend -- \
            curl -X POST http://localhost:3000/api/version/update \
            -H "Content-Type: application/json" \
            -d '{"version": "${{ github.sha }}", "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"}'

      - name: Deployment summary
        run: |
          echo "=== Deployment Summary ==="
          echo "Commit SHA: ${{ github.sha }}"
          echo "Deployed at: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo ""
          echo "Services:"
          kubectl get services -n app-deployment
          echo ""
          echo "Deployments:"
          kubectl get deployments -n app-deployment
          echo ""
          echo "Pods:"
          kubectl get pods -n app-deployment

      # - name: Trigger app update notification
      #   run: |
      #     # React Native 앱들에게 업데이트 알림 전송
      #     kubectl exec -n app-deployment deployment/nestjs-backend -- \
      #       curl -X POST http://localhost:3000/api/push-notification/update \
      #       -H "Content-Type: application/json" \
      #       -d '{"message": "New version available", "forceUpdate": false}'
